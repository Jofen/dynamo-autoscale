#!/usr/bin/env ruby

require_relative '../config/environment/common'

if ARGV[0]
  DynamoAutoscale.setup_from_config(ARGV[0])
elsif ARGV[0].nil?
  STDERR.puts "Usage: dynamo-autoscale path/to/config.yml"

  exit 1
elsif ARGV[0] and !File.exists?(ARGV[0])
  STDERR.puts "Usage: dynamo-autoscale path/to/config.yml"
  STDERR.puts "Error: The path you specified is to a file that does not exist."

  exit 1
end

DynamoAutoscale.logger.info "Ensuring tables exist in DynamoDB..."
dynamo = AWS::DynamoDB.new

DynamoAutoscale.poller_opts[:tables].select! do |table_name|
  if dynamo.tables[table_name].exists?
    true
  else
    DynamoAutoscale.logger.error "Table #{table_name} does not exist inside your DynamoDB."
    false
  end
end

DynamoAutoscale.poller_class = DynamoAutoscale::CWPoller

unless DynamoAutoscale.config[:dry_run]
  DynamoAutoscale.actioner_class = DynamoAutoscale::DynamoActioner
end

DynamoAutoscale.logger.info "Finished setup. Starting polling loop."
DynamoAutoscale.poller.run
